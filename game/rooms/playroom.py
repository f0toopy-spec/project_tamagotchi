import pygame
from .base_room import BaseRoom
from entities.buttons import Button
from config import *


class Playroom(BaseRoom):
    """–ö–ª–∞—Å—Å –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã –≤ –∏–≥—Ä–µ Tamagotchi Pou.
    
    –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–º–∞–≥–æ—á–∏
    –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –µ–≥–æ —É—Ä–æ–≤–Ω—è —Å—á–∞—Å—Ç—å—è. –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏–≥—Ä—É—à–∫–∏ –∏ –¥–æ—Å—Ç—É–ø
    –∫ –º–∏–Ω–∏-–∏–≥—Ä–∞–º –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–µ—Å–µ–ª—å—è.
    
    –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
    - –ò–≥—Ä–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã: –º—è—á, –∫—É–±–∏–∫–∏, –≥–æ—Ä–∫–∞, —è—â–∏–∫ —Å –∏–≥—Ä—É—à–∫–∞–º–∏
    - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∏–¥–æ–≤ –∏–≥—Ä—ã
    - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å—á–∞—Å—Ç—å—è –∏ —ç–Ω–µ—Ä–≥–∏–∏
    - –î–æ—Å—Ç—É–ø –∫ –º–∏–Ω–∏-–∏–≥—Ä–∞–º —á–µ—Ä–µ–∑ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
    """
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–≥—Ä–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É.
        
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞, —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        –∏ –≤–µ—Å–µ–ª—å–µ, –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è –∏–≥—Ä.
        """
        super().__init__("Playroom", (150, 200, 100))  # –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω
        self.setup()

    def setup(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã.
        
        –°–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏–≥—Ä–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –∏
        –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã.
        """
        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π
        self.buttons = [
            Button(250, 500, 150, 50, "Play Ball", YELLOW),   # –ò–≥—Ä–∞—Ç—å —Å –º—è—á–æ–º
            Button(450, 500, 150, 50, "Mini-games", BLUE)     # –ú–∏–Ω–∏-–∏–≥—Ä—ã
        ]

    def draw(self, screen, tamagotchi):
        """–û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∏–≥—Ä–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            screen: –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å PyGame –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            tamagotchi: –û–±—ä–µ–∫—Ç —Ç–∞–º–∞–≥–æ—á–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            
        –ü–æ—Ä—è–¥–æ–∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏:
        1. –§–æ–Ω –∫–æ–º–Ω–∞—Ç—ã –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        2. –ò–≥—Ä–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –∏–≥—Ä—É—à–∫–∏
        3. –°—Ç–∞—Ç—É—Å—ã —Å—á–∞—Å—Ç—å—è –∏ —ç–Ω–µ—Ä–≥–∏–∏
        4. –¢–∞–º–∞–≥–æ—á–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–æ–º–Ω–∞—Ç—ã
        5. –ö–Ω–æ–ø–∫–∏ –∏ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        """
        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–æ–Ω –∫–æ–º–Ω–∞—Ç—ã –±–µ–∑ —Ç–∞–º–∞–≥–æ—á–∏ —Å–Ω–∞—á–∞–ª–∞
        screen.fill(self.background_color)
        title = self.font.render(f"{self.name}", True, WHITE)
        screen.blit(title, (SCREEN_WIDTH // 2 - title.get_width() // 2, 30))
        
        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∫–æ–º–Ω–∞—Ç—ã
        for obj in self.objects:
            obj.draw(screen)

        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
        
        # –Ø—â–∏–∫ —Å –∏–≥—Ä—É—à–∫–∞–º–∏
        pygame.draw.rect(screen, (139, 69, 19), (100, 200, 100, 80))  # –ö–æ—Ä–ø—É—Å —è—â–∏–∫–∞
        pygame.draw.rect(screen, (160, 120, 80), (105, 205, 90, 70))  # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —á–∞—Å—Ç—å

        # –ú—è—á
        pygame.draw.circle(screen, RED, (300, 250), 30)

        # –ö—É–±–∏–∫–∏
        pygame.draw.rect(screen, BLUE, (400, 220, 40, 40))    # –°–∏–Ω–∏–π –∫—É–±–∏–∫
        pygame.draw.rect(screen, GREEN, (450, 220, 40, 40))   # –ó–µ–ª–µ–Ω—ã–π –∫—É–±–∏–∫
        pygame.draw.rect(screen, YELLOW, (500, 220, 40, 40))  # –ñ–µ–ª—Ç—ã–π –∫—É–±–∏–∫

        # –ì–æ—Ä–∫–∞
        pygame.draw.polygon(screen, (255, 200, 0), [(600, 300), (650, 200), (700, 300)])
        pygame.draw.line(screen, BLACK, (625, 250), (625, 300), 3)

        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å—á–∞—Å—Ç—å—è
        if tamagotchi:
            happiness_text = self.font.render(f"Happiness: {tamagotchi.data.happiness}/100", True, WHITE)
            screen.blit(happiness_text, (50, 100))

            energy_text = self.font.render(f"Energy: {tamagotchi.data.energy}/100", True, WHITE)
            screen.blit(energy_text, (50, 140))

            # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≥—Ä—É—Å—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            if tamagotchi.data.happiness < 30:
                sad_text = self.small_font.render("Your tamagotchi is sad! Play with it!", True, YELLOW)
                screen.blit(sad_text, (50, 180))
        
        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–º–∞–≥–æ—á–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç—É—Ä (—Å–ø–µ—Ä–µ–¥–∏)
        if tamagotchi:
            tamagotchi.draw(screen, SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2)
        
        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        for button in self.buttons:
            button.draw(screen)
        
        # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        self.draw_navigation_arrows(screen)

    def handle_events(self, event, mouse_pos, tamagotchi, game_core):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            event: –°–æ–±—ã—Ç–∏–µ PyGame –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            mouse_pos: –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ –º—ã—à–∏ (x, y)
            tamagotchi: –û–±—ä–µ–∫—Ç —Ç–∞–º–∞–≥–æ—á–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            game_core: –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
            
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            str: –ò–º—è –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ ("playroom" –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
            
        –ú–µ—Ö–∞–Ω–∏–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
        1. –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ "Play Ball": –ø—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞ —Å –º—è—á–æ–º (–ø–æ–≤—ã—à–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ)
        2. –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ "Mini-games": –∑–∞–ø—Ä–æ—Å –º–µ–Ω—é –º–∏–Ω–∏-–∏–≥—Ä (—Ç—Ä–µ–±—É–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏)
        3. –ö–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–µ–ª–∫–∞—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å–µ–¥–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        """
        # –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∞–º–∏ —á–µ—Ä–µ–∑ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
        result = super().handle_events(event, mouse_pos, tamagotchi, game_core)
        if result:
            return result

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏
        if event.type == pygame.MOUSEBUTTONDOWN and event.button == 1:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å —Å –º—è—á–æ–º"
            if self.buttons[0].rect.collidepoint(mouse_pos):
                if tamagotchi:
                    if tamagotchi.play():
                        # –£—Å–ø–µ—à–Ω–∞—è –∏–≥—Ä–∞ —Å –º—è—á–æ–º
                        game_core.show_message("Played ball with your tamagotchi! üéæ")
                        game_core.auto_save()  # –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–≥—Ä—ã
                    else:
                        # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –∏–≥—Ä—ã
                        game_core.show_message("Not enough energy to play!")
                return "playroom"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É "–ú–∏–Ω–∏-–∏–≥—Ä—ã" - –ù–ï –í–´–ó–´–í–ê–ï–ú show_minigame_menu() –Ω–∞–ø—Ä—è–º—É—é!
            if self.buttons[1].rect.collidepoint(mouse_pos):
                if tamagotchi and tamagotchi.data.energy >= 20:
                    # –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –º–µ–Ω—é –º–∏–Ω–∏-–∏–≥—Ä
                    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
                    game_core.request_minigame_menu = True
                    return "playroom"
                else:
                    # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –º–∏–Ω–∏-–∏–≥—Ä
                    game_core.show_message("Not enough energy for mini-games!")
                return "playroom"

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏
        for button in self.buttons:
            button.check_hover(mouse_pos)

        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Å—Ç–∞–µ–º—Å—è –≤ –∏–≥—Ä–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ
        return "playroom"